<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cart — Her Choice PH</title>
  <!-- Google Fonts (reuse from pageMain) -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;600;700&family=Funnel+Display:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
  <style>
  /* ===================[ Cart Page Styles ]=================== */
  :root{
    --bg: #FFF7E7;
    --dark: #6C0002;
    --gold: #F0B135;
    --text: #6C0002;

    --xxs:4px; --xs:8px; --sm:12px; --md:16px; --lg:24px; --xl:32px; --xxl:48px;
  }
  html,body{height:100%;}
  body{
    margin:0; font-family:'Funnel Display', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
  }
  .top-header{background:#490506;color:var(--bg);display:flex;align-items:center;justify-content:space-between;padding:12px 20px;position:sticky;top:0;z-index:30}
  .top-header a, .top-header button{color:var(--bg);text-decoration:none}
  .logo{height:44px}

  main.container{max-width:1200px;margin:28px auto;padding:0 20px;display:grid;grid-template-columns:1fr 380px;gap:24px;align-items:start}

  /* Left content */
  .cart-main{background:transparent}
  .section-card{background:var(--bg);padding:18px;border-radius:8px;border:1px solid rgba(108,0,2,0.06)}

  .sets-row{display:flex;flex-direction:column;gap:12px}
  label.small{font-size:0.9rem;margin-bottom:6px;display:block}
  select.set-select{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);font-family:inherit;font-size:1rem}

  .set-note{font-size:0.9rem;color:rgba(108,0,2,0.85);margin-top:6px}

  .extras-list{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .extra-item{background:var(--bg);padding:12px;border-radius:8px;border:1px solid rgba(108,0,2,0.06);display:flex;gap:12px;align-items:center}
  .extra-item img{width:64px;height:64px;object-fit:cover;border-radius:6px}
  .extra-meta{flex:1}
  .extra-title{font-family:'Merriweather', serif;font-weight:600;font-size:1rem}
  .extra-price{color:var(--dark);font-weight:600;margin-top:6px}

  .qty-controls{display:flex;align-items:center;gap:8px}
  .qty-controls button{background:var(--dark);border:none;color:var(--bg);padding:6px 10px;border-radius:6px;cursor:pointer}
  .qty-display{min-width:32px;text-align:center}
  .remove-btn{background:transparent;border:1px solid rgba(108,0,2,0.12);color:var(--dark);padding:6px 8px;border-radius:6px;cursor:pointer}

  /* Sidebar */
  aside.cart-sidebar{position:relative}
  .sidebar-card{background:var(--bg);padding:18px;border-radius:8px;border:1px solid rgba(108,0,2,0.06);display:flex;flex-direction:column;gap:12px}

  .total-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;background:transparent;border:1px dashed rgba(240,177,53,0.12)}
  .total-row .label{font-weight:700;font-family:'Merriweather',serif}
  .total-row .amount{font-weight:700;color:var(--dark);font-size:1.25rem}

  .form-field{display:flex;flex-direction:column;gap:6px}
  .form-field input,.form-field textarea, .form-field select{padding:10px;border-radius:8px;border:1px solid rgba(108,0,2,0.12);font-size:0.95rem}
  textarea{min-height:84px;resize:vertical}

  .place-order{background:var(--dark);color:var(--bg);border:none;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;font-size:1rem}
  .place-order:hover{background:var(--gold);color:#6C0002}

  .undo-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#fff;padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);display:flex;gap:8px;align-items:center;box-shadow:none}
  .undo-bar button{background:transparent;border:1px solid rgba(108,0,2,0.12);padding:6px 8px;border-radius:6px;color:var(--dark);cursor:pointer}

  @media (max-width:980px){
    main.container{grid-template-columns:1fr; padding:12px}
    .extras-list{grid-template-columns:1fr}
  }
  </style>
</head>
<body>
  <!-- Reused header from pageMain.html -->
  <header class="top-header">
    <div class="header-left">
      <button class="burger-menu" aria-label="Open menu">
        <span class="material-symbols-outlined">menu</span>
      </button>
      <img src="logo-small.png" alt="Logo" class="logo-small" style="height:34px;margin-left:8px">
    </div>

    <nav class="header-middle" style="display:flex;gap:18px;align-items:center">
      <a href="pageMain.html">Shop</a>
      <a href="#about-brand">About</a>
      <a href="#footer">Contact</a>
      <img src="logo-large.png" alt="Logo" class="logo" style="margin-left:12px">
    </nav>

    <div class="header-right">
      <a class="cart-btn" href="cart.html" aria-label="View cart">
        <span class="material-symbols-outlined">shopping_cart</span>
      </a>
    </div>
  </header>

  <main class="container">
    <section class="cart-main">
      <h1 style="font-family:'Merriweather',serif;margin:6px 0 12px 0">Your Cart</h1>

      <div class="section-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:0.95rem;color:rgba(108,0,2,0.9)">Select your Set</div>
            <label class="small" for="set-select">Available Sets</label>
            <select id="set-select" class="set-select" aria-label="Select set"></select>
            <div id="set-note" class="set-note"></div>
          </div>
          <div style="min-width:140px;text-align:right">
            <div style="font-size:0.85rem;color:rgba(108,0,2,0.6)">Selected price</div>
            <div id="selected-set-price" style="font-family:'Merriweather',serif;font-weight:700;color:var(--dark);font-size:1.1rem">₱0.00</div>
          </div>
        </div>

        <hr style="border:none;height:12px">

        <h3 style="font-family:'Merriweather',serif;margin:6px 0">Bonus Products</h3>
        <div class="extras-list" id="extras-list">
          <!-- extras injected here -->
        </div>
      </div>

      <div style="height:16px"></div>

      <div class="section-card">
        <h3 style="font-family:'Merriweather',serif;margin:6px 0">Order Summary</h3>
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
          <div>Items subtotal</div>
          <div id="items-subtotal">₱0.00</div>
        </div>
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:8px">
          <div>Shipping</div>
          <div id="shipping">₱0.00</div>
        </div>
        <div style="height:8px"></div>
        <div class="total-row">
          <div class="label">Total</div>
          <div id="cart-total" class="amount">₱0.00</div>
        </div>
      </div>
    </section>

    <aside class="cart-sidebar">
      <div class="sidebar-card">
        <div class="total-row" style="flex-direction:column;align-items:stretch">
          <div style="display:flex;justify-content:space-between"><div class="label">Order total</div><div id="sidebar-total-top" class="amount">₱0.00</div></div>
          <div style="font-size:0.9rem;color:rgba(108,0,2,0.7);margin-top:6px">Please fill all required fields (*)</div>
        </div>

        <form id="checkout-form" onsubmit="return false" aria-label="Checkout form">
          <div class="form-field"><label>Fullname*</label><input id="fullname" name="fullname" required placeholder="Juan dela Cruz"></div>
          <div class="form-field"><label>Phone*</label><input id="phone" name="phone" required placeholder="09xxxxxxxxx"></div>
          <div class="form-field"><label>Email</label><input id="email" name="email" type="email" placeholder="you@example.com"></div>
          <div class="form-field"><label>Facebook</label><input id="facebook" name="facebook" placeholder="facebook.com/yourprofile"></div>
          <div class="form-field"><label>Address*</label><input id="address" name="address" required placeholder="Street, Barangay"></div>
          <div style="display:grid;grid-template-columns:1fr 120px;gap:8px">
            <div class="form-field"><label>City*</label><input id="city" name="city" required placeholder="City/Town"></div>
            <div class="form-field"><label>Postal Code*</label><input id="postal" name="postal" required placeholder="1000"></div>
          </div>
          <div class="form-field"><label>Mode of payment*</label>
            <select id="payment-mode" name="payment" required>
              <option value="cod">Cash on Delivery</option>
              <option value="gpay">GCash</option>
              <option value="bank">Bank Transfer</option>
            </select>
          </div>
          <div class="form-field"><label>Additional comments</label><textarea id="comments" name="comments" placeholder="Delivery notes, preferred time..."></textarea></div>

          <div style="height:6px"></div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div id="sidebar-total-bottom" style="display:flex;justify-content:space-between;align-items:center"><strong>Total</strong><strong id="sidebar-total-bottom-amount">₱0.00</strong></div>
            <button id="place-order" class="place-order">Place order</button>
          </div>
        </form>
      </div>
    </aside>
  </main>

  <div class="undo-bar" id="undo-bar" style="display:none">
    <div id="undo-msg">Action added</div>
    <button id="undo-action">Undo</button>
    <button id="undo-close">Close</button>
  </div>

  <script>
  // Cart page script: manages sets dropdown, extras list, quantities, totals and LIFO push/undo/list
  (function(){
    const SETS = [
      { id: 'set-c-1', name: 'Set-C (1 Set)', price: 885, note: '15% OFF PLUS SHIPPING FEE INCLUDED!' },
      { id: 'set-c-2', name: 'Set-C (2 Sets)', price: 1675, note: '15% OFF PLUS FREE SHIPPING!' },
      { id: 'set-c-3', name: 'Set-C (3 Sets)', price: 2470, note: '25% OFF + FREE SHIPPING!' }
    ];

    /* === Extras catalog (images referenced in Resources/) === */
    const EXTRAS = [
      { id: 'extra-1', name: 'IBB Soap (1 Bar)', price: 148, note: '15% OFF!', img:'Resources/Product Section.png'},
      { id: 'extra-2', name: 'Sunshield SPF50 (1 Bottle)', price: 288, note: '15% OFF!', img:'Resources/Product Section.png'}
    ];

    // storage keys
    const CART_KEY = 'hc_cart_v1'; // main cart state
    const STACK_KEY = 'hc_cart_stack_v1'; // LIFO action stack

  /* === Storage helpers === */
  function readCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || { set:null, extras: [] }; } catch(e){ return { set:null, extras: [] }; } }
    function writeCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); renderCart(); }

    // LIFO stack actions (local push shim, undoCart, listCart)
    function readStack(){ try { return JSON.parse(localStorage.getItem(STACK_KEY)) || []; } catch(e){ return []; } }
    function writeStack(stack){ localStorage.setItem(STACK_KEY, JSON.stringify(stack)); }

    // Local page shim: record an action to the LIFO stack so Undo works.
    // The canonical implementation in /public/js/site.js will provide `window.pushCart`.
    function pushCartLocal(action){ // action: { type:'add_extra'|'update_qty'|'set_change'|'remove_extra', payload:... }
      const stack = readStack();
      stack.push({ ts:Date.now(), action });
      writeStack(stack);
      showUndoBar('Action saved — you can undo');
    }

    function undoCart(){ const stack = readStack(); if (!stack.length) return null; const last = stack.pop(); writeStack(stack); // reverse action
      const act = last.action;
      const cart = readCart();
      if (act.type === 'add_extra'){
        cart.extras = cart.extras.filter(e=>e.id !== act.payload.id);
      } else if (act.type === 'remove_extra'){
        cart.extras.push(act.payload.prev);
      } else if (act.type === 'update_qty'){
        const ex = cart.extras.find(e=>e.id===act.payload.id);
        if (ex) ex.qty = act.payload.prevQty;
      } else if (act.type === 'set_change'){
        cart.set = act.payload.prevSet;
      }
      writeCart(cart);
      renderCart();
      return last;
    }

    function listCart(){ return readCart(); }

    // UI helpers
    const setSelect = document.getElementById('set-select');
    const setNote = document.getElementById('set-note');
    const selectedPriceEl = document.getElementById('selected-set-price');
    const extrasListEl = document.getElementById('extras-list');
    const subtotalEl = document.getElementById('items-subtotal');
    const shippingEl = document.getElementById('shipping');
    const cartTotalEl = document.getElementById('cart-total');
    const sidebarTop = document.getElementById('sidebar-total-top');
    const sidebarBottom = document.getElementById('sidebar-total-bottom-amount');

    function formatPHPeso(n){ return '₱' + Number(n).toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2}); }

    // populate sets
  /* === UI: Sets dropdown === */
  function initSets(){
      setSelect.innerHTML = '';
      SETS.forEach(s=>{
        const opt = document.createElement('option'); opt.value = s.id; opt.textContent = `${s.name} - ${formatPHPeso(s.price)}`; setSelect.appendChild(opt);
      });
      setSelect.addEventListener('change', ()=>{
        const prev = readCart().set || null;
        const newSet = SETS.find(s=>s.id===setSelect.value) || null;
        const cart = readCart();
        cart.set = newSet ? { id:newSet.id, name:newSet.name, price:newSet.price } : null;
        writeCart(cart);
        pushCartLocal({ type:'set_change', payload:{ prevSet: prev, newSet: cart.set } });
      });
    }

    // populate extras
  /* === UI: Extras list rendering === */
  function renderExtras(){
      extrasListEl.innerHTML = '';
      EXTRAS.forEach(ex=>{
        const item = document.createElement('div'); item.className='extra-item'; item.dataset.id = ex.id;
        item.innerHTML = `
          <img src="${ex.img}" alt="${ex.name}">
          <div class="extra-meta">
            <div class="extra-title">${ex.name}</div>
            <div class="extra-price">${formatPHPeso(ex.price)} <span style="font-size:0.8rem;color:rgba(108,0,2,0.6);font-weight:500">${ex.note}</span></div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <div class="qty-controls">
              <button class="dec" aria-label="Decrease">-</button>
              <div class="qty-display">0</div>
              <button class="inc" aria-label="Increase">+</button>
            </div>
            <div style="display:flex;gap:6px"><button class="remove-btn">Remove</button></div>
          </div>
        `;

        // attach behavior
        const dec = item.querySelector('.dec');
        const inc = item.querySelector('.inc');
        const qtyDisplay = item.querySelector('.qty-display');
        const removeBtn = item.querySelector('.remove-btn');

        function setQty(q, silent){
          q = Math.max(0, Math.floor(Number(q)||0)); qtyDisplay.textContent = q;
          const cart = readCart();
          const existing = cart.extras.find(e=>e.id===ex.id);
          if (q === 0){
              if (existing) { // remove
              const prev = Object.assign({}, existing);
              cart.extras = cart.extras.filter(x=>x.id!==ex.id);
              writeCart(cart);
              pushCartLocal({ type:'remove_extra', payload:{ id:ex.id, prev } });
            }
          } else {
            if (existing) { const prevQty = existing.qty || 1; existing.qty = q; writeCart(cart); pushCartLocal({ type:'update_qty', payload:{ id:ex.id, prevQty } }); }
            else { const newItem = { id:ex.id, name:ex.name, price:ex.price, qty:q }; cart.extras.push(newItem); writeCart(cart); pushCartLocal({ type:'add_extra', payload:{ id:ex.id, qty:q } }); if (window.persistCartItem) window.persistCartItem(newItem); }
          }
        }

        inc.addEventListener('click', ()=>{ const n = Number(qtyDisplay.textContent)||0; setQty(n+1); });
        dec.addEventListener('click', ()=>{ const n = Number(qtyDisplay.textContent)||0; setQty(Math.max(0,n-1)); });
        removeBtn.addEventListener('click', ()=>{ setQty(0); });

        extrasListEl.appendChild(item);
      });
    }

  /* === Render cart state (reads hc_cart_v1) === */
  function renderCart(){
      const cart = readCart();
      // set selection
      if (cart.set) { setSelect.value = cart.set.id; const s = SETS.find(x=>x.id===cart.set.id); setNote.textContent = s ? s.note : ''; selectedPriceEl.textContent = formatPHPeso(cart.set.price); }
      else { setSelect.value = '' ; setNote.textContent=''; selectedPriceEl.textContent = '₱0.00'; }

      // extras quantities
      EXTRAS.forEach(ex=>{
        const el = extrasListEl.querySelector(`.extra-item[data-id="${ex.id}"]`);
        const qtyDisplay = el && el.querySelector('.qty-display');
        const existing = (cart.extras||[]).find(e=>e.id===ex.id);
        if (qtyDisplay) qtyDisplay.textContent = existing ? (existing.qty||1) : '0';
      });

      // totals
      let subtotal = 0; if (cart.set) subtotal += Number(cart.set.price||0);
      (cart.extras||[]).forEach(e=>{ subtotal += Number(e.price||0) * (Number(e.qty)||1); });
      // determine shipping: if set includes shipping in note for set 1 it's included; let's assume set-c-1 has shipping included, others free shipping for 2 or 3
      let shipping = 0;
      if (cart.set && cart.set.id === 'set-c-1') shipping = 0; // included per note
      else if (cart.set && (cart.set.id === 'set-c-2' || cart.set.id === 'set-c-3')) shipping = 0; // free shipping
      else shipping = 80; // if no set selected, flat shipping for extras

      subtotalEl.textContent = formatPHPeso(subtotal);
      shippingEl.textContent = formatPHPeso(shipping);
      const total = subtotal + shipping;
      cartTotalEl.textContent = formatPHPeso(total);
      sidebarTop.textContent = formatPHPeso(total);
      sidebarBottom.textContent = formatPHPeso(total);
      document.getElementById('sidebar-total-bottom-amount').textContent = formatPHPeso(total);
    }

    // React to cart changes made on other pages (storage event) so pageMain/cart stay in sync
    window.addEventListener('storage', (e)=>{
      if (e.key === CART_KEY || e.key === null) { // null can mean clear
        // re-render from storage
        renderCart();
      }
    });

    // Undo bar
    const undoBar = document.getElementById('undo-bar');
    const undoActionBtn = document.getElementById('undo-action');
    const undoCloseBtn = document.getElementById('undo-close');
    function showUndoBar(msg){ document.getElementById('undo-msg').textContent = msg || 'Action saved'; undoBar.style.display = 'flex'; }
    undoActionBtn.addEventListener('click', ()=>{ undoCart(); undoBar.style.display='none'; });
    undoCloseBtn.addEventListener('click', ()=>{ undoBar.style.display='none'; });

    // Place order -> POST to API and show toast
    document.getElementById('place-order').addEventListener('click', async ()=>{
      const cart = readCart();
      const form = document.getElementById('checkout-form');
      if (!cart.set){ window.toast ? window.toast('Please select a set before placing an order.') : alert('Please select a set before placing an order.'); setSelect.focus(); return; }
      if (!form.reportValidity()) { return; }

      const payload = {
        fullname: form.fullname.value,
        phone: form.phone.value,
        email: form.email.value,
        address: form.address.value,
        city: form.city.value,
        postal: form.postal.value,
        payment: form.payment.value,
        comments: form.comments.value,
        cart: cart,
        total: Number((document.getElementById('cart-total').textContent||'₱0').replace(/[₱,]/g,'')) || 0
      };

      try{
        const resp = await fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!resp.ok){
          // Try to parse response error and fallback to Supabase push if server refuses
          const errBody = await resp.json().catch(()=>({ error: resp.statusText }));
          const status = resp.status;
          if ((status === 405 || status === 404 || status === 501) && typeof window.pushOrder === 'function'){
            // fallback to Supabase client if available
            const ok = await window.pushOrder(payload).catch(()=>false);
            if (ok) {
              localStorage.removeItem(CART_KEY); localStorage.removeItem(STACK_KEY); renderCart(); if (window.toast) window.toast('Order saved (fallback) — thank you!'); else alert('Order saved — thank you!'); return;
            }
          }
          throw new Error(errBody.error || errBody || 'Request failed');
        }
        const data = await resp.json();
        // clear cart
        localStorage.removeItem(CART_KEY); localStorage.removeItem(STACK_KEY);
        renderCart();
        if (window.toast) window.toast('Order placed — thank you!'); else alert('Order placed — thank you!');
      }catch(e){
        console.error(e);
        // Always attempt Supabase fallback when the server POST fails
        if (typeof window.pushOrder === 'function'){
          try{
            const ok = await window.pushOrder(payload);
            if (ok){ localStorage.removeItem(CART_KEY); localStorage.removeItem(STACK_KEY); renderCart(); if (window.toast) window.toast('Order saved (fallback) — thank you!'); else alert('Order saved — thank you!'); return; }
          }catch(pe){ console.warn('pushOrder fallback failed', pe); }
        }
        if (window.toast) window.toast('Failed to place order: ' + (e.message||'error')); else alert('Failed to place order: ' + (e.message||'error'));
      }
    });

    // initial setup
    initSets(); renderExtras(); renderCart();

    // Export only low-level read/write hooks for legacy pages; cart actions are provided by /public/js/site.js
    window.__hc_readCart = readCart; window.__hc_writeCart = writeCart;
  })();
  </script>
  <script src="/public/js/supabase-config.js"></script>
  <script type="module">
    import './public/js/core.js';
    import './public/js/site.js';
  </script>
</body>
</html>
